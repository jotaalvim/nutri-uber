<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= content_for(:title) || "Nutri Dashboard" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= action_cable_meta_tag %>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Fraunces:ital,opsz,wght@0,9..144,500;0,9..144,600;0,9..144,700&display=swap" rel="stylesheet">

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
  </head>

  <body class="bg-amber-50 text-stone-800 antialiased min-h-screen">
    <div class="min-h-screen flex flex-col">
      <header class="sticky top-0 z-10 bg-white/95 backdrop-blur-sm border-b border-stone-200/80 shadow-sm">
        <div class="mx-auto max-w-6xl px-4 py-4 sm:px-6 lg:px-8">
          <div class="flex items-center gap-3">
            <span class="text-3xl" aria-hidden="true">ü•ó</span>
            <div>
              <h1 class="font-display text-xl font-semibold text-stone-800">Nutri Dashboard</h1>
              <p class="text-xs text-stone-500">Nutrition planning at a glance</p>
            </div>
          </div>
        </div>
      </header>
      <main class="flex-1 mx-auto w-full max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
        <%= yield %>
      </main>
    </div>

    <%# Chat widget - floating button + panel %>
    <div id="chat-widget" class="fixed bottom-6 right-6 z-50">
      <div id="chat-panel" class="hidden absolute bottom-16 right-0 w-[min(380px,calc(100vw-2rem))] h-[min(520px,70vh)] rounded-2xl bg-white border border-stone-200/80 shadow-xl flex flex-col overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white">
          <span class="font-display font-semibold">Nutrition Assistant</span>
          <button type="button" id="chat-close" class="p-1.5 rounded-lg hover:bg-white/20 transition-colors" aria-label="Close chat">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">
          <div id="chat-greeting" class="rounded-xl bg-amber-50 border border-amber-200/60 px-4 py-3 text-stone-600">
            Hi! I'm your nutrition assistant. Ask me about meal planning, macros, or which items from the food cards to order. I'll recommend from the dishes shown above.
          </div>
        </div>
        <div class="p-3 border-t border-stone-200 bg-stone-50/80">
          <form id="chat-form" class="flex gap-2" data-turbo="false" action="/chat" method="post">
            <input type="text" id="chat-input" placeholder="Ask about nutrition‚Ä¶" autocomplete="off"
              class="flex-1 px-4 py-2.5 rounded-xl border border-stone-200 bg-white text-stone-800 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 text-sm">
            <button type="submit" id="chat-send" class="px-4 py-2.5 rounded-xl bg-emerald-600 text-white font-medium text-sm hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              Send
            </button>
          </form>
        </div>
      </div>
      <button type="button" id="chat-toggle" class="w-14 h-14 rounded-full bg-emerald-600 text-white shadow-lg hover:bg-emerald-700 transition-colors flex items-center justify-center" aria-label="Open chat">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
      </button>
    </div>

    <script>
      (function() {
        const toggle = document.getElementById("chat-toggle");
        const panel = document.getElementById("chat-panel");
        const closeBtn = document.getElementById("chat-close");
        const form = document.getElementById("chat-form");
        const input = document.getElementById("chat-input");
        const messagesEl = document.getElementById("chat-messages");
        const sendBtn = document.getElementById("chat-send");

        let chatHistory = [];
        const STORAGE_KEY_PREFIX = "nutri_chat_";

        function getPatientId() {
          return (typeof window.nutriPatientData !== "undefined" && window.nutriPatientData && window.nutriPatientData.patient_id) ? window.nutriPatientData.patient_id : null;
        }

        function getStorageKey() {
          return STORAGE_KEY_PREFIX + (getPatientId() || "default");
        }

        function loadChatFromStorage() {
          try {
            const key = getStorageKey();
            const raw = localStorage.getItem(key);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
          } catch (_) { return []; }
        }

        function saveChatToStorage() {
          try {
            const key = getStorageKey();
            localStorage.setItem(key, JSON.stringify(chatHistory));
          } catch (_) {}
        }

        function addConversationSeparator() {
          const sep = document.createElement("div");
          sep.className = "flex justify-center py-3";
          sep.setAttribute("aria-hidden", "true");
          sep.innerHTML = '<div class="flex items-center gap-3 w-full min-w-0">' +
            '<span class="flex-1 h-px bg-gradient-to-r from-transparent via-emerald-300/60 to-transparent shrink"></span>' +
            '<span class="text-emerald-500/80 text-[10px] font-medium tracking-widest shrink-0">‚Äî ¬∑ ‚Äî</span>' +
            '<span class="flex-1 h-px bg-gradient-to-r from-transparent via-emerald-300/60 to-transparent shrink"></span>' +
            '</div>';
          messagesEl.appendChild(sep);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function renderPersistedChat(history) {
          const greeting = document.getElementById("chat-greeting");
          if (!greeting) return;
          let next = greeting.nextElementSibling;
          while (next) {
            const toRemove = next;
            next = next.nextElementSibling;
            toRemove.remove();
          }
          chatHistory = Array.isArray(history) ? history : [];
          chatHistory.forEach(function(msg) {
            if (msg.role && msg.content) {
              addMessage(msg.role, msg.content, true);
              if (msg.role === "user") addConversationSeparator();
            }
          });
        }

        function openChat() { panel.classList.remove("hidden"); input.focus(); }
        function closeChat() { panel.classList.add("hidden"); }
        window.openChat = openChat;

        toggle.addEventListener("click", openChat);
        closeBtn.addEventListener("click", closeChat);

        function escapeHtml(s) {
          const div = document.createElement("div");
          div.textContent = s || "";
          return div.innerHTML;
        }

        function addMessage(role, content, skipSave) {
          const isUser = role === "user";
          const bubble = document.createElement("div");
          bubble.className = "flex " + (isUser ? "justify-end" : "justify-start");
          bubble.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2.5 ' +
            (isUser ? 'bg-emerald-600 text-white' : 'bg-stone-100 text-stone-800') + '">' +
            '<div class="whitespace-pre-wrap break-words">' + escapeHtml(content) + '</div></div>';
          messagesEl.appendChild(bubble);
          if (!skipSave && (role === "user" || role === "assistant")) {
            chatHistory.push({ role: role, content: content });
            saveChatToStorage();
          }
          if (!skipSave && role === "user") {
            addConversationSeparator();
          }
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addOrderReasonPrompt() {
          const prompt = "Why did you choose to order in today? Sharing your reason helps your nutritionist understand your situation and support you better.";
          addMessage("assistant", prompt);
          chatHistory.push({ role: "assistant", content: prompt });
          input.placeholder = "e.g. Tired, no time to cook, celebrating‚Ä¶";
        }
        window.addOrderReasonPrompt = addOrderReasonPrompt;

        function addSecondOrderConfirmPrompt() {
          const prompt = "You've already ordered in today. Do you really need to order again? Tell me why.";
          addMessage("assistant", prompt);
          chatHistory.push({ role: "assistant", content: prompt });
          input.placeholder = "e.g. Still hungry, unexpected guests‚Ä¶";
        }
        window.addSecondOrderConfirmPrompt = addSecondOrderConfirmPrompt;

        function addMedicationWarning(message, pendingOrder) {
          const bubble = document.createElement("div");
          bubble.className = "flex justify-start";
          bubble.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2.5 bg-amber-100 border border-amber-300 text-amber-900">' +
            '<p class="font-medium text-sm">‚ö†Ô∏è Medication interaction</p>' +
            '<p class="text-sm mt-1 whitespace-pre-wrap break-words">' + escapeHtml(message) + '</p>' +
            '<p class="text-xs mt-2 text-amber-700">You can still order if you wish, but please be aware of these risks.</p></div>';
          messagesEl.appendChild(bubble);
          if (pendingOrder) {
            window.nutriPendingMedicationAcknowledgement = pendingOrder;
            const promptBubble = document.createElement("div");
            promptBubble.className = "flex justify-start";
            promptBubble.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2.5 bg-stone-100 text-stone-700">' +
              '<p class="text-sm">Please reply in the chat to confirm you understand the risks before we can complete your order.</p></div>';
            messagesEl.appendChild(promptBubble);
            input.placeholder = "e.g. I understand the risks, I accept‚Ä¶";
          }
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        window.addMedicationWarning = addMedicationWarning;

        function addChatOrderCard(item, url, patientId, userReason) {
          const macros = item.macronutrient_distribution_in_grams || {};
          const macroStr = [macros.protein, macros.carbohydrate, macros.fat].some(Boolean)
            ? "P " + (macros.protein || "‚Äî") + "g ¬∑ C " + (macros.carbohydrate || "‚Äî") + "g ¬∑ F " + (macros.fat || "‚Äî") + "g"
            : "Nutrition varies";
          const itemB64 = btoa(unescape(encodeURIComponent(JSON.stringify(item))));
          const reasonB64 = userReason ? btoa(unescape(encodeURIComponent(userReason))) : "";
          const bubble = document.createElement("div");
          bubble.className = "flex justify-start";
          bubble.innerHTML = '<div class="max-w-[85%] rounded-2xl overflow-hidden bg-white border border-stone-200 shadow-md p-4">' +
            '<p class="font-semibold text-stone-800 mb-1">' + escapeHtml(item.name || "") + '</p>' +
            '<p class="text-xs text-stone-500 mb-2">' + escapeHtml(item.restaurant || "") + '</p>' +
            '<p class="text-xs text-amber-700 mb-3">' + escapeHtml(macroStr) + '</p>' +
            '<p class="text-lg font-bold text-stone-800 mb-3">' + escapeHtml(item.price || "‚Äî") + '</p>' +
            '<button type="button" class="chat-order-btn w-full px-4 py-2.5 rounded-xl font-medium text-sm bg-emerald-600 text-white hover:bg-emerald-700" data-url="' + escapeHtml(url) + '" data-patient-id="' + escapeHtml(String(patientId)) + '" data-item-b64="' + itemB64 + '" data-reason-b64="' + reasonB64 + '">Order ‚Üí</button></div>';
          messagesEl.appendChild(bubble);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        messagesEl.addEventListener("click", async function(e) {
          const btn = e.target.closest(".chat-order-btn");
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          const itemB64 = btn.dataset.itemB64;
          const urlToOpen = btn.dataset.url;
          const pid = btn.dataset.patientId;
          const reasonB64 = btn.dataset.reasonB64 || "";
          if (!itemB64 || !urlToOpen || !pid) return;
          let itemObj;
          try {
            itemObj = JSON.parse(decodeURIComponent(escape(atob(itemB64))));
          } catch (_) { return; }
          const logItem = { name: itemObj.name, restaurant: itemObj.restaurant };
          if (itemObj.nutriments && Object.keys(itemObj.nutriments || {}).length) logItem.nutriments = itemObj.nutriments;
          btn.disabled = true;
          btn.textContent = "‚Ä¶";
          let orderReason = "";
          if (reasonB64) {
            try { orderReason = decodeURIComponent(escape(atob(reasonB64))); } catch (_) {}
          }
          try {
            const checkRes = await fetch("/check_food_medication", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "", "Accept": "application/json" },
              body: JSON.stringify({ patient_id: pid, food_item: { name: itemObj.name, description: itemObj.description || "" } })
            });
            const checkData = await checkRes.json();
            if (checkData.has_risk && checkData.warning_message) {
              addMedicationWarning(checkData.warning_message, { logItem: logItem, url: urlToOpen, patientId: pid, orderReason: orderReason });
              btn.disabled = false;
              btn.textContent = "Order ‚Üí";
              return;
            }
          } catch (_) {}
          try {
            const res = await fetch("/add_to_food_log", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "", "Accept": "application/json" },
              body: JSON.stringify({ patient_id: pid, items: [logItem], meal_type: "Refei√ß√£o", from_order: true, order_reason: orderReason })
            });
            const data = await res.json();
            if (res.ok) {
              window.open(urlToOpen, "_blank", "noopener");
              addMessage("assistant", "Order added. The page will refresh to show your update.");
              window.location.reload();
            } else {
              addMessage("assistant", data.error || "Could not add to log");
              btn.disabled = false;
              btn.textContent = "Order ‚Üí";
            }
          } catch (err) {
            addMessage("assistant", err.message || "Failed");
            btn.disabled = false;
            btn.textContent = "Order ‚Üí";
          }
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const text = input.value.trim();
          if (!text) return;

          input.value = "";
          sendBtn.disabled = true;
          addMessage("user", text);

          const medAck = window.nutriPendingMedicationAcknowledgement;
          if (medAck && medAck.logItem && medAck.url && medAck.patientId) {
            window.nutriPendingMedicationAcknowledgement = null;
            input.placeholder = "Ask about nutrition‚Ä¶";
            try {
              const res = await fetch("/add_to_food_log", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "", "Accept": "application/json" },
                body: JSON.stringify({ patient_id: medAck.patientId, items: [medAck.logItem], meal_type: "Refei√ß√£o", from_order: true, order_reason: medAck.orderReason || "" })
              });
              const data = await res.json();
              if (res.ok) {
                window.open(medAck.url, "_blank", "noopener");
                if (!medAck.orderReason) {
                  const today = new Date().toISOString().slice(0, 10);
                  sessionStorage.setItem("nutriOrderReasonPrompt", JSON.stringify({ patientId: medAck.patientId, date: today }));
                }
                addMessage("assistant", "Order added. The page will refresh to show your update.");
                window.location.reload();
              } else {
                addMessage("assistant", data.error || "Could not add to log");
              }
            } catch (err) {
              addMessage("assistant", err.message || "Failed");
            } finally {
              sendBtn.disabled = false;
              input.focus();
            }
            return;
          }

          const pending = window.nutriOrderReasonPending;
          if (pending && pending.patientId && pending.date) {
            try {
              const res = await fetch("/save_order_reason", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "",
                  "Accept": "application/json"
                },
                body: JSON.stringify({ patient_id: pending.patientId, date: pending.date, reason: text })
              });
              const data = await res.json();
              window.nutriOrderReasonPending = null;
              input.placeholder = "Ask about nutrition‚Ä¶";
              if (res.ok) {
                addMessage("assistant", "Thanks for sharing. Your nutritionist will see this to better support you.");
                if (data.order_out_entries && typeof window.updateOrderOutSection === "function") {
                  window.updateOrderOutSection(data.order_out_entries);
                }
              } else {
                addMessage("assistant", "Couldn't save: " + (data.error || "Please try again."));
              }
            } catch (err) {
              addMessage("assistant", "Connection error. Your reason wasn't saved.");
            } finally {
              sendBtn.disabled = false;
              input.focus();
            }
            return;
          }

          const secondOrder = window.nutriPendingSecondOrder;
          if (secondOrder && secondOrder.patientId && secondOrder.item) {
            chatHistory.push({ role: "user", content: text });
            const thinking = document.createElement("div");
            thinking.className = "flex justify-start";
            thinking.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2.5 bg-stone-100 text-stone-500 italic">Thinking‚Ä¶</div>';
            messagesEl.appendChild(thinking);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            try {
              const patientId = (typeof window.nutriPatientData !== "undefined" && window.nutriPatientData) ? window.nutriPatientData.patient_id : secondOrder.patientId;
              const res = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "", "Accept": "application/json" },
                body: JSON.stringify({
                  messages: chatHistory,
                  confirm_second_order: true,
                  pending_item: secondOrder.item,
                  patient_id: patientId
                })
              });
              const resText = await res.text();
              const data = resText ? JSON.parse(resText) : {};
              thinking.remove();
              if (res.ok && data.message) {
                addMessage("assistant", data.message);
                chatHistory.push({ role: "assistant", content: data.message });
                if (data.order_approved) {
                  addChatOrderCard(secondOrder.item, secondOrder.url, secondOrder.patientId, text);
                }
                window.nutriPendingSecondOrder = null;
                input.placeholder = "Ask about nutrition‚Ä¶";
              } else {
                addMessage("assistant", "Sorry, I couldn't get a response. " + (data.error || "Please try again."));
              }
            } catch (err) {
              thinking.remove();
              addMessage("assistant", "Connection error. " + (err.message || "Please try again."));
            } finally {
              sendBtn.disabled = false;
              input.focus();
            }
            return;
          }

          chatHistory.push({ role: "user", content: text });

          const thinking = document.createElement("div");
          thinking.className = "flex justify-start";
          thinking.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2.5 bg-stone-100 text-stone-500 italic">Thinking‚Ä¶</div>';
          messagesEl.appendChild(thinking);
          messagesEl.scrollTop = messagesEl.scrollHeight;

          try {
            const foodItems = (typeof window.nutriDashboardFoodItems !== "undefined" && Array.isArray(window.nutriDashboardFoodItems))
              ? window.nutriDashboardFoodItems : [];
            const patientId = (typeof window.nutriPatientData !== "undefined" && window.nutriPatientData) ? window.nutriPatientData.patient_id : null;
            const res = await fetch("/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "",
                "Accept": "application/json"
              },
              body: JSON.stringify({ messages: chatHistory, food_items: foodItems, patient_id: patientId })
            });
            let data;
            try {
              const resText = await res.text();
              data = resText ? JSON.parse(resText) : {};
            } catch (parseErr) {
              thinking.remove();
              addMessage("assistant", "Server returned an invalid response (HTML instead of JSON). The /chat endpoint may be missing. Rebuild: docker-compose build --no-cache && docker-compose up -d");
              return;
            } finally {}
            thinking.remove();
            if (res.ok && data.message) {
              addMessage("assistant", data.message);
              chatHistory.push({ role: "assistant", content: data.message });
            } else {
              addMessage("assistant", "Sorry, I couldn't get a response. " + (data.error || "Please try again."));
            }
          } catch (err) {
            thinking.remove();
            addMessage("assistant", "Connection error: " + (err.message || "Make sure the API is running and OPENAI_API_KEY is set."));
          } finally {
            sendBtn.disabled = false;
            input.focus();
          }
        });

        (function initChatFromStorage() {
          const stored = loadChatFromStorage();
          if (stored.length > 0) {
            renderPersistedChat(stored);
          }
        })();

        (function checkOrderReasonPrompt() {
          try {
            const stored = sessionStorage.getItem("nutriOrderReasonPrompt");
            if (stored) {
              sessionStorage.removeItem("nutriOrderReasonPrompt");
              const { patientId, date } = JSON.parse(stored);
              if (patientId && date) {
                window.nutriOrderReasonPending = { patientId, date };
                openChat();
                addOrderReasonPrompt();
              }
            }
          } catch (_) {}
        })();

        window.nutriChatLoadForPatient = function() {
          const stored = loadChatFromStorage();
          if (stored.length > 0) {
            renderPersistedChat(stored);
          } else {
            const greeting = document.getElementById("chat-greeting");
            if (greeting) {
              let next = greeting.nextElementSibling;
              while (next) {
                const toRemove = next;
                next = next.nextElementSibling;
                toRemove.remove();
              }
            }
            chatHistory = [];
          }
        };
      })();
    </script>
  </body>
</html>
