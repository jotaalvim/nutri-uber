<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= content_for(:title) || "Nutri Dashboard" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Fraunces:ital,opsz,wght@0,9..144,500;0,9..144,600;0,9..144,700&display=swap" rel="stylesheet">

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
  </head>

  <body class="bg-amber-50 text-stone-800 antialiased min-h-screen">
    <div class="min-h-screen flex flex-col">
      <header class="sticky top-0 z-10 bg-white/95 backdrop-blur-sm border-b border-stone-200/80 shadow-sm">
        <div class="mx-auto max-w-6xl px-4 py-4 sm:px-6 lg:px-8">
          <div class="flex items-center gap-3">
            <span class="text-3xl" aria-hidden="true">ðŸ¥—</span>
            <div>
              <h1 class="font-display text-xl font-semibold text-stone-800">Nutri Dashboard</h1>
              <p class="text-xs text-stone-500">Nutrition planning at a glance</p>
            </div>
          </div>
        </div>
      </header>
      <main class="flex-1 mx-auto w-full max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
        <%= yield %>
      </main>
    </div>

    <%# Chat widget - floating button + panel %>
    <div id="chat-widget" class="fixed bottom-6 right-6 z-50">
      <div id="chat-panel" class="hidden absolute bottom-16 right-0 w-[min(380px,calc(100vw-2rem))] h-[min(520px,70vh)] rounded-2xl bg-white border border-stone-200/80 shadow-xl flex flex-col overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white">
          <span class="font-display font-semibold">Nutrition Assistant</span>
          <button type="button" id="chat-close" class="p-1.5 rounded-lg hover:bg-white/20 transition-colors" aria-label="Close chat">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">
          <div class="rounded-xl bg-amber-50 border border-amber-200/60 px-4 py-3 text-stone-600">
            Hi! I'm your nutrition assistant. Ask me about meal planning, macros, or which items from the food cards to order. I'll recommend from the dishes shown above.
          </div>
        </div>
        <div class="p-3 border-t border-stone-200 bg-stone-50/80">
          <form id="chat-form" class="flex gap-2" data-turbo="false" action="/chat" method="post">
            <input type="text" id="chat-input" placeholder="Ask about nutritionâ€¦" autocomplete="off"
              class="flex-1 px-4 py-2.5 rounded-xl border border-stone-200 bg-white text-stone-800 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 text-sm">
            <button type="submit" id="chat-send" class="px-4 py-2.5 rounded-xl bg-emerald-600 text-white font-medium text-sm hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              Send
            </button>
          </form>
        </div>
      </div>
      <button type="button" id="chat-toggle" class="w-14 h-14 rounded-full bg-emerald-600 text-white shadow-lg hover:bg-emerald-700 transition-colors flex items-center justify-center" aria-label="Open chat">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
      </button>
    </div>

    <script>
      (function() {
        const toggle = document.getElementById("chat-toggle");
        const panel = document.getElementById("chat-panel");
        const closeBtn = document.getElementById("chat-close");
        const form = document.getElementById("chat-form");
        const input = document.getElementById("chat-input");
        const messagesEl = document.getElementById("chat-messages");
        const sendBtn = document.getElementById("chat-send");

        let chatHistory = [];

        function openChat() { panel.classList.remove("hidden"); input.focus(); }
        function closeChat() { panel.classList.add("hidden"); }

        toggle.addEventListener("click", openChat);
        closeBtn.addEventListener("click", closeChat);

        function escapeHtml(s) {
          const div = document.createElement("div");
          div.textContent = s || "";
          return div.innerHTML;
        }

        function addMessage(role, content) {
          const isUser = role === "user";
          const bubble = document.createElement("div");
          bubble.className = "flex " + (isUser ? "justify-end" : "justify-start");
          bubble.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2.5 ' +
            (isUser ? 'bg-emerald-600 text-white' : 'bg-stone-100 text-stone-800') + '">' +
            '<div class="whitespace-pre-wrap break-words">' + escapeHtml(content) + '</div></div>';
          messagesEl.appendChild(bubble);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const text = input.value.trim();
          if (!text) return;

          input.value = "";
          sendBtn.disabled = true;
          addMessage("user", text);
          chatHistory.push({ role: "user", content: text });

          const thinking = document.createElement("div");
          thinking.className = "flex justify-start";
          thinking.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2.5 bg-stone-100 text-stone-500 italic">Thinkingâ€¦</div>';
          messagesEl.appendChild(thinking);
          messagesEl.scrollTop = messagesEl.scrollHeight;

          try {
            const foodItems = (typeof window.nutriDashboardFoodItems !== "undefined" && Array.isArray(window.nutriDashboardFoodItems))
              ? window.nutriDashboardFoodItems : [];
            const res = await fetch("/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "",
                "Accept": "application/json"
              },
              body: JSON.stringify({ messages: chatHistory, food_items: foodItems })
            });
            let data;
            try {
              const text = await res.text();
              data = text ? JSON.parse(text) : {};
            } catch (parseErr) {
              thinking.remove();
              addMessage("assistant", "Server returned an invalid response (HTML instead of JSON). The /chat endpoint may be missing. Rebuild: docker-compose build --no-cache && docker-compose up -d");
              return;
            } finally {}
            thinking.remove();
            if (res.ok && data.message) {
              addMessage("assistant", data.message);
              chatHistory.push({ role: "assistant", content: data.message });
            } else {
              addMessage("assistant", "Sorry, I couldn't get a response. " + (data.error || "Please try again."));
            }
          } catch (err) {
            thinking.remove();
            addMessage("assistant", "Connection error: " + (err.message || "Make sure the API is running and OPENAI_API_KEY is set."));
          } finally {
            sendBtn.disabled = false;
            input.focus();
          }
        });
      })();
    </script>
  </body>
</html>
