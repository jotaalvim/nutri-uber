<% content_for :title, "Nutri Dashboard" %>

<div class="space-y-6">
  <section class="rounded-2xl bg-white border border-stone-200/80 shadow-sm p-4 sm:p-5">
    <div class="flex flex-wrap items-center gap-2 sm:gap-3">
      <span class="text-sm font-medium text-stone-500 flex items-center gap-1.5">
        <span aria-hidden="true">üë§</span>
        Select patient
      </span>
      <div class="flex flex-wrap gap-2">
        <% @patients.each do |patient| %>
          <%= link_to patient.patient_name,
              dashboard_path(patient_id: patient.id),
              class: "px-4 py-2 rounded-xl font-medium text-sm transition-all duration-200 #{@selected_patient&.id == patient.id ? 'bg-amber-500 text-white shadow-md ring-2 ring-amber-400/50' : 'bg-amber-50 text-stone-600 hover:bg-amber-100 hover:text-stone-800 border border-stone-200/60'}" %>
        <% end %>
      </div>
    </div>
  </section>

  <% if @selected_patient && @selected_patient.last_order_out.present? %>
    <% last_date = @selected_patient.last_order_out %>
    <% begin; last_display = Date.parse(last_date.to_s).strftime("%B %d, %Y"); rescue; last_display = last_date; end %>
    <div class="rounded-2xl border border-amber-200/80 bg-gradient-to-r from-amber-50 to-orange-50/50 p-5 shadow-sm" data-order-reminder-banner>
      <p class="text-sm font-medium text-amber-800">
        <span aria-hidden="true">üíõ</span>
        Last time you ordered out: <strong><%= last_display %></strong>
      </p>
      <p class="mt-2 text-sm text-amber-700/90 leading-relaxed">
        Cooking at home isn‚Äôt just healthier‚Äîit‚Äôs a small act of care for yourself. Every meal you make is a step toward feeling better. You‚Äôve got this.
      </p>
    </div>
  <% end %>

  <% if @selected_patient %>
    <section class="rounded-2xl bg-gradient-to-br from-amber-500/10 via-amber-50 to-emerald-500/10 border border-stone-200/80 shadow-sm p-6 sm:p-8">
      <h2 class="font-display text-lg font-semibold text-stone-800 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üéØ</span>
        Daily nutrition goals
        <% if @selected_patient.ordered_out_today? %>
          <span class="text-xs font-normal text-amber-600">(remaining after order)</span>
        <% end %>
      </h2>
      <% eff_protein = @selected_patient.effective_protein_grams %>
      <% eff_carbs = @selected_patient.effective_carbohydrate_grams %>
      <% eff_fat = @selected_patient.effective_fat_grams %>
      <% consumed = @selected_patient.order_out_consumed_today %>
      <% base_p = @selected_patient.protein_grams.to_f %>
      <% base_c = @selected_patient.carbohydrate_grams.to_f %>
      <% base_f = @selected_patient.fat_grams.to_f %>
      <% pct_p = base_p > 0 ? [(consumed["protein"].to_f / base_p) * 100, 100].min : 0 %>
      <% pct_c = base_c > 0 ? [(consumed["carbohydrate"].to_f / base_c) * 100, 100].min : 0 %>
      <% pct_f = base_f > 0 ? [(consumed["fat"].to_f / base_f) * 100, 100].min : 0 %>
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-6">
        <div>
          <p class="text-sm text-stone-500 mb-0.5">Total energy (DEE)</p>
          <p class="text-4xl sm:text-5xl font-display font-bold text-amber-600">
            <%= @selected_patient.effective_dee_goal %>
            <span class="text-xl font-normal text-stone-500"><%= @selected_patient.dee_goal_unit.presence || "kcal" %></span>
          </p>
        </div>
        <div class="flex-1 max-w-md space-y-3">
          <div class="flex items-center gap-3">
            <span class="text-xs font-medium text-stone-500 w-16">Protein</span>
            <div class="flex-1 h-2.5 bg-stone-200 rounded-full overflow-hidden">
              <div class="h-full bg-orange-500 rounded-full transition-all" style="width: <%= pct_p %>%"></div>
            </div>
            <span class="text-sm font-semibold text-stone-700 w-12 text-right"><%= eff_protein == eff_protein.to_i ? eff_protein.to_i : "%.1f" % eff_protein %>g</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs font-medium text-stone-500 w-16">Carbs</span>
            <div class="flex-1 h-2.5 bg-stone-200 rounded-full overflow-hidden">
              <div class="h-full bg-amber-500 rounded-full transition-all" style="width: <%= pct_c %>%"></div>
            </div>
            <span class="text-sm font-semibold text-stone-700 w-12 text-right"><%= eff_carbs == eff_carbs.to_i ? eff_carbs.to_i : "%.1f" % eff_carbs %>g</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs font-medium text-stone-500 w-16">Fat</span>
            <div class="flex-1 h-2.5 bg-stone-200 rounded-full overflow-hidden">
              <div class="h-full bg-emerald-600 rounded-full transition-all" style="width: <%= pct_f %>%"></div>
            </div>
            <span class="text-sm font-semibold text-stone-700 w-12 text-right"><%= eff_fat == eff_fat.to_i ? eff_fat.to_i : "%.1f" % eff_fat %>g</span>
          </div>
          <div class="pt-2 flex items-center gap-2 text-sm text-stone-600">
            <span aria-hidden="true">üåæ</span>
            <% eff_fiber = @selected_patient.effective_fiber_grams %>
            <span><strong>Fiber:</strong> <%= eff_fiber == eff_fiber.to_i ? eff_fiber.to_i : "%.1f" % eff_fiber %>g/day</span>
          </div>
        </div>
      </div>
    </section>

    <div class="grid gap-6 lg:grid-cols-2">
      <% dietary = @selected_patient.dietary_history %>
      <section class="rounded-2xl bg-white border border-stone-200/80 shadow-sm p-6">
        <h2 class="font-display text-lg font-semibold text-stone-800 mb-4 flex items-center gap-2">
          <span aria-hidden="true">üçΩÔ∏è</span>
          Dietary info
        </h2>
        <dl class="space-y-4">
          <div class="flex gap-3">
            <dt class="text-stone-500 text-sm font-medium w-24 shrink-0">Schedule</dt>
            <dd class="text-stone-800 text-sm">
              <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-lg bg-amber-100 text-stone-700">
                ‚òÄÔ∏è <%= dietary["wake_up_time_24h"].presence || "‚Äî" %>
              </span>
              <span class="text-stone-400 mx-1">‚Üí</span>
              <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-lg bg-stone-100 text-stone-700">
                üåô <%= dietary["bedtime_24h"].presence || "‚Äî" %>
              </span>
            </dd>
          </div>
          <div class="flex gap-3">
            <dt class="text-stone-500 text-sm font-medium w-24 shrink-0">Favorites</dt>
            <dd class="text-stone-800 text-sm"><%= dietary["favorite_foods"].presence || "‚Äî" %></dd>
          </div>
          <div class="flex gap-3">
            <dt class="text-stone-500 text-sm font-medium w-24 shrink-0">Disliked</dt>
            <dd class="text-stone-800 text-sm"><%= dietary["disliked_foods"].presence || "‚Äî" %></dd>
          </div>
          <div class="flex gap-3">
            <dt class="text-stone-500 text-sm font-medium w-24 shrink-0">Allergies</dt>
            <dd class="text-stone-800 text-sm">
              <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-sm <%= @selected_patient.has_allergies? ? 'bg-orange-100 text-orange-800 font-medium' : 'bg-emerald-100 text-emerald-800' %>">
                <% if @selected_patient.has_allergies? %>
                  ‚ö†Ô∏è <%= @selected_patient.safe_get(dietary, %w[food_allergies details]) %>
                <% else %>
                  ‚úì None reported
                <% end %>
              </span>
            </dd>
          </div>
        </dl>
      </section>

      <% medical = @selected_patient.medical_history %>
      <section class="rounded-2xl bg-white border border-stone-200/80 shadow-sm p-6">
        <h2 class="font-display text-lg font-semibold text-stone-800 mb-4 flex items-center gap-2">
          <span aria-hidden="true">üíä</span>
          Medical
        </h2>
        <dl class="space-y-4">
          <div class="flex gap-3">
            <dt class="text-stone-500 text-sm font-medium w-24 shrink-0">Conditions</dt>
            <dd class="text-stone-800 text-sm"><%= @selected_patient.safe_get(medical, %w[diseases details]).presence || "‚Äî" %></dd>
          </div>
          <div class="flex gap-3">
            <dt class="text-stone-500 text-sm font-medium w-24 shrink-0">Medications</dt>
            <dd class="text-stone-800 text-sm"><%= medical["medications"].presence || "‚Äî" %></dd>
          </div>
        </dl>
      </section>
    </div>

    <%# Ready-to-order meals + basket in one card %>
    <section class="rounded-2xl bg-white border border-stone-200/80 shadow-sm p-6 sm:p-8" id="food-finder-section">
      <h2 class="font-display text-lg font-semibold text-stone-800 mb-4 flex items-center gap-2">
        <span aria-hidden="true">ü•°</span>
        Find healthy food
      </h2>
      <p class="text-sm text-stone-600 mb-4">
        Ready-to-order meals and grocery baskets. Respects allergies, intolerances, dislikes; favors your favorite ingredients.
      </p>
      <button type="button"
        data-patient-id="<%= @selected_patient.id %>"
        data-find-food-trigger
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-medium text-sm bg-emerald-600 text-white hover:bg-emerald-700 transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
        <span data-find-food-spinner class="hidden">‚è≥</span>
      </button>
      <div data-find-food-results class="mt-6 <%= @initial_food_items.any? ? '' : 'hidden' %>">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <p class="text-sm font-medium text-stone-700" data-find-food-count></p>
        </div>
        <div data-find-food-list class="flex gap-4 overflow-x-auto pb-4 -mx-1 scroll-smooth snap-x snap-mandatory" style="scrollbar-width: thin;"></div>
      </div>
      <div data-find-food-error class="mt-4 hidden text-sm text-red-600"></div>
    </section>

    <% diary = @selected_patient.food_diary %>
    <section class="rounded-2xl bg-white border border-stone-200/80 shadow-sm p-6 sm:p-8">
      <h2 class="font-display text-lg font-semibold text-stone-800 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üìã</span>
        Food diary
      </h2>
      <% if diary.any? %>
        <div class="space-y-6">
          <% diary.each do |entry| %>
            <div class="rounded-xl border border-stone-200/80 bg-amber-50/50 p-5">
              <div class="flex flex-wrap items-center gap-2 mb-3">
                <span class="text-sm font-semibold text-stone-700"><%= entry["date"] %></span>
                <% if entry["observations"].to_s.strip.present? %>
                  <span class="text-xs text-stone-500">‚Ä¢</span>
                  <p class="text-sm text-stone-600 flex-1 min-w-0"><%= entry["observations"] %></p>
                <% end %>
              </div>
              <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                <% (entry["meals"] || []).each do |meal| %>
                  <div class="rounded-lg bg-white border border-stone-200/60 p-3 shadow-sm">
                    <p class="text-xs font-medium text-amber-600 uppercase tracking-wide mb-1"><%= meal["meal_type"] %></p>
                    <p class="text-sm text-stone-700"><%= meal["text"] %></p>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-stone-500 text-sm py-4">No food diary entries yet.</p>
      <% end %>
    </section>

    <% order_out_list = @selected_patient.order_out_entries %>
    <section class="rounded-2xl bg-white border border-stone-200/80 shadow-sm p-6 sm:p-8">
      <h2 class="font-display text-lg font-semibold text-stone-800 mb-4 flex items-center gap-2">
        <span aria-hidden="true">ü•°</span>
        Eating out
      </h2>
      <% if order_out_list.any? %>
        <div class="space-y-4">
          <% order_out_list.each do |entry| %>
            <% consumed = entry["_consumed"] || {} %>
            <% date_display = begin; Date.parse(entry["date"].to_s).strftime("%B %d, %Y"); rescue; entry["date"]; end %>
            <div class="rounded-xl border border-amber-200/60 bg-amber-50/30 p-4">
              <p class="text-sm font-semibold text-stone-700 mb-2"><%= date_display %></p>
              <ul class="space-y-1.5 mb-3">
                <% (entry["meals"] || []).each do |meal| %>
                  <li class="text-sm text-stone-600 flex items-center gap-2">
                    <span class="text-amber-500">‚Ä¢</span>
                    <%= meal["text"] %>
                  </li>
                <% end %>
              </ul>
              <% if consumed.present? && consumed["energy_kcal"].to_f.positive? %>
                <p class="text-xs text-stone-500">
                  <%= consumed["energy_kcal"] %> kcal
                  <% if consumed["protein"].to_f.positive? || consumed["carbohydrate"].to_f.positive? || consumed["fat"].to_f.positive? %>
                    ¬∑ P <%= consumed["protein"] %>g ¬∑ C <%= consumed["carbohydrate"] %>g ¬∑ F <%= consumed["fat"] %>g
                  <% end %>
                </p>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-stone-500 text-sm py-4">No eating out recorded yet.</p>
      <% end %>
    </section>

    <%= content_for :head do %>
      <script type="application/json" id="initial-food-items"><%= raw @initial_food_items.to_json.gsub("</", "<\\/") %></script>
      <script>
        function initFindFood() {
          const btn = document.querySelector("[data-find-food-trigger]");
          if (!btn) return;
          const patientId = btn.dataset.patientId;
          const resultsEl = document.querySelector("[data-find-food-results]");
          const listEl = document.querySelector("[data-find-food-list]");
          const countEl = document.querySelector("[data-find-food-count]");
          const errorEl = document.querySelector("[data-find-food-error]");
          if (!listEl) return;

          listEl.addEventListener("click", async (e) => {
            const orderBtn = e.target.closest("[data-order-btn]");
            if (orderBtn) {
              e.preventDefault();
              const card = orderBtn.closest("[data-item-name]");
              const url = orderBtn.dataset.orderUrl || "#";
              if (!card || !url || url === "#") return;
              const name = card.dataset.itemName || "";
              const restaurant = card.dataset.itemRestaurant || "";
              let nutriments = null;
              try {
                const nutStr = card.dataset.itemNutrition || card.getAttribute("data-item-nutrition") || "";
                if (nutStr) nutriments = JSON.parse(nutStr);
              } catch (_) {}
              const item = { name: name, restaurant: restaurant };
              if (nutriments && Object.keys(nutriments).length) item.nutriments = nutriments;
              orderBtn.disabled = true;
              orderBtn.textContent = "‚Ä¶";
              try {
                const res = await fetch("/add_to_food_log", {
                  method: "POST",
                  headers: { "Content-Type": "application/json", "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "", "Accept": "application/json" },
                  body: JSON.stringify({ patient_id: patientId, items: [item], meal_type: "Refei√ß√£o", from_order: true })
                });
                const data = await res.json();
                if (res.ok) {
                  window.open(url, "_blank", "noopener");
                  window.location.reload();
                } else {
                  alert(data.error || "Could not add to log");
                  orderBtn.disabled = false;
                  orderBtn.textContent = "Order ‚Üí";
                }
              } catch (err) {
                alert(err.message || "Failed");
                orderBtn.disabled = false;
                orderBtn.textContent = "Order ‚Üí";
              }
              return;
            }
            const refreshBtn = e.target.closest("[data-refresh-nutrition]");
            if (!refreshBtn) return;
            e.preventDefault();
            e.stopPropagation();
            const panel = refreshBtn.closest("[data-nutrition-panel]");
            const card = panel?.closest("[data-item-name]");
            if (!panel || !card) return;
            const name = card.dataset.itemName || "";
            panel.innerHTML = '<div class="p-6 text-center text-amber-600 text-sm">Loading‚Ä¶</div>';
            try {
              const desc = (card.dataset.itemDescription || "").trim();
              const imgUrl = (card.dataset.itemImageUrl || "").trim();
              let res;
              if (imgUrl || desc) {
                res = await fetch("/nutrition?refresh=1", {
                  method: "POST",
                  headers: { "Content-Type": "application/json", "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "", "Accept": "application/json" },
                  body: JSON.stringify({ q: name, description: desc, image_url: imgUrl, refresh: true })
                });
              } else {
                res = await fetch("/nutrition?q=" + encodeURIComponent(name) + "&refresh=1");
              }
              const data = await res.json();
              if (data.error) {
                panel.innerHTML = '<div class="p-6 text-center text-red-600 text-sm">' + escapeHtml(data.error) + '</div>';
                return;
              }
              const nut = data.nutriments || {};
              const p = (nut.protein || 0), c = (nut.carbohydrate || 0), f = (nut.fat || 0);
              const totalMacro = p + c + f;
              const hasMacros = totalMacro > 0;
              const pctP = hasMacros ? (p / totalMacro) * 100 : 33.3;
              const pctC = hasMacros ? (c / totalMacro) * 100 : 33.3;
              const pctF = hasMacros ? (f / totalMacro) * 100 : 33.3;
              const conic = hasMacros
                ? `conic-gradient(#ea580c 0% ${pctP}%, #d97706 ${pctP}% ${pctP + pctC}%, #059669 ${pctP + pctC}% 100%)`
                : "conic-gradient(#e7e5e4 0% 100%)";
              const energy = nut.energy_kcal != null ? nut.energy_kcal : null;
              const hasAny = energy != null || hasMacros || (nut.fiber != null || nut.sugar != null || nut.sodium != null || nut.salt != null);
              const extras = [
                { icon: "üåø", label: "Fiber", val: nut.fiber, unit: "g" },
                { icon: "üç¨", label: "Sugar", val: nut.sugar, unit: "g" },
                { icon: "üßÇ", label: "Sodium", val: nut.sodium, unit: "g" },
                { icon: "üßÇ", label: "Salt", val: nut.salt, unit: "g" }
              ].filter(x => x.val != null);
              let html = '<div class="p-5 space-y-4">';
              html += '<div class="flex items-center gap-4">';
              html += '<div class="shrink-0 w-20 h-20 rounded-full border-4 border-white shadow-md" style="background: ' + conic + '"></div>';
              html += '<div class="flex-1 min-w-0 space-y-1">';
              if (energy != null) html += '<div class="text-lg font-bold text-stone-800">' + escapeHtml(String(energy)) + ' <span class="text-sm font-normal text-stone-500">kcal</span></div>';
              html += '<div class="flex flex-wrap gap-x-3 gap-y-0.5 text-xs">';
              if (hasMacros) {
                html += '<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Protein ' + escapeHtml(String(p)) + 'g</span>';
                html += '<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span> Carbs ' + escapeHtml(String(c)) + 'g</span>';
                html += '<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-600"></span> Fat ' + escapeHtml(String(f)) + 'g</span>';
              } else {
                html += '<span class="text-stone-500">Macros not available</span>';
              }
              html += '</div></div></div>';
              if (extras.length) {
                html += '<div class="flex flex-wrap gap-2">';
                extras.forEach(x => {
                  html += '<div class="flex items-center gap-1.5 rounded-lg bg-white/80 px-3 py-1.5 text-xs shadow-sm border border-stone-100"><span>' + x.icon + '</span><span class="text-stone-600">' + escapeHtml(x.label) + '</span><span class="font-semibold text-stone-800">' + escapeHtml(String(x.val)) + x.unit + '</span></div>';
                });
                html += '</div>';
              }
              if (data.source) html += '<div class="pt-1 text-[10px] text-stone-400">Source: ' + escapeHtml(data.source === "openai_vision" ? "AI estimate" : data.source === "generic_estimate" ? "Rough estimate" : "Open Food Facts") + (data.confidence ? ' ¬∑ ' + escapeHtml(data.confidence) + ' confidence' : '') + '</div>';
              if (data.notes) html += '<div class="pt-0.5 text-[10px] text-stone-500 italic">' + escapeHtml(data.notes) + '</div>';
              html += '<div class="pt-2"><button type="button" data-refresh-nutrition class="text-xs text-amber-600 hover:text-amber-700 hover:underline">Refresh values</button></div>';
              html += '</div>';
              panel.innerHTML = hasAny ? html : '<div class="p-6 text-center text-stone-500 text-sm">No nutrition data found</div><div class="p-2"><button type="button" data-refresh-nutrition class="text-xs text-amber-600 hover:text-amber-700 hover:underline">Refresh values</button></div>';
              panel.dataset.loaded = "1";
              card.dataset.itemNutrition = JSON.stringify(nut);
              card.dataset.itemNutritionSource = data.source || "";
            } catch (err) {
              panel.innerHTML = '<div class="p-6 text-center text-red-600 text-sm">Failed to load</div>';
            }
          });

          function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
          }

          let currentItems = [];
          window.nutriDashboardFoodItems = [];

          function mergeItems(foodData, basketData) {
            const restaurantItems = (foodData?.items || []).map(i => ({ ...i, from_cache: foodData.from_cache }));
            const basketItems = (basketData?.items || []).map(i => ({
              ...i,
              restaurant: basketData.store || i.restaurant,
              restaurant_url: basketData.store_url || i.restaurant_url,
              store_url: basketData.store_url
            }));
            return [...restaurantItems, ...basketItems];
          }

          function renderResults(dataOrItems) {
            const raw = Array.isArray(dataOrItems) ? dataOrItems : (dataOrItems?.items || []);
            const items = shuffle(raw).slice(0, 20);
            currentItems = items;
            window.nutriDashboardFoodItems = items.map(i => ({
              name: i.name,
              restaurant: i.restaurant,
              price: i.price,
              basket_role: i.basket_role,
              description: (i.description || "").slice(0, 120),
              macronutrient_distribution_in_grams: i.macronutrient_distribution_in_grams || {}
            }));
            const cached = items.some(i => i.from_cache);
            countEl.textContent = `Found ${items.length} items for <%= @selected_patient&.patient_name %>${cached ? " (ready to order)" : ""}`;
            const SHOP_FEED = "ubereats.com/feeds/shop_feed";
            const roleEmoji = { protein: "ü•©", carbohydrate: "üåæ", vegetable: "ü•¨", vegetable_or_fruit: "üçé", drink: "ü•§" };
            function placeholderForItem(it) {
              const emoji = roleEmoji[it.basket_role] || "ü•ó";
              return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='160'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23fef3c7'/%3E%3Cstop offset='100%25' stop-color='%23fde68a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='280' height='160' fill='url(%23g)'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='48'%3E" + encodeURIComponent(emoji) + "%3C/text%3E%3C/svg%3E";
            }
            const defaultPlaceholder = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='160'%3E%3Crect width='280' height='160' fill='%23f5f5f4'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23a8a29e' font-size='14'%3Eü•ó%3C/text%3E%3C/svg%3E";
            listEl.innerHTML = items.map((item, idx) => {
              const hasImg = !!(item.image_url && item.image_url.startsWith("http"));
              const primaryImg = hasImg ? item.image_url : (item.basket_role ? placeholderForItem(item) : defaultPlaceholder);
              const macros = item.macronutrient_distribution_in_grams || {};
              const macroStr = [macros.protein, macros.carbohydrate, macros.fat].some(Boolean)
                ? `P ${macros.protein || "‚Äî"}g ¬∑ C ${macros.carbohydrate || "‚Äî"}g ¬∑ F ${macros.fat || "‚Äî"}g`
                : "Nutrition varies by portion";
              let orderUrl = item.product_url || item.restaurant_url || item.store_url || "#";
              if (orderUrl.includes(SHOP_FEED) || orderUrl === "https://www.ubereats.com/feeds/shop_feed") {
                orderUrl = "https://www.ubereats.com/pt-en/feed?q=" + encodeURIComponent(item.name || "");
              }
              const roleBadge = item.basket_role ? `<span class="text-xs px-2 py-0.5 rounded bg-amber-200 text-amber-800">${escapeHtml(item.basket_role)}</span>` : "";
              const itemDesc = (item.description || "").trim();
              const itemImg = (item.image_url && item.image_url.startsWith("http")) ? item.image_url : "";
              const itemNut = item.nutriments ? JSON.stringify(item.nutriments) : "";
              const itemNutSource = item.nutrition_source || "";
              return `
              <div class="shrink-0 w-72 snap-center rounded-2xl overflow-hidden bg-white border border-stone-200/80 shadow-md hover:shadow-lg transition-shadow flex flex-col" data-item-name="${escapeHtml(item.name)}" data-item-restaurant="${escapeHtml(item.restaurant || '')}" data-item-description="${escapeHtml(itemDesc)}" data-item-image-url="${escapeHtml(itemImg)}" data-item-nutrition="${escapeHtml(itemNut)}" data-item-nutrition-source="${escapeHtml(itemNutSource)}">
                <div class="block cursor-default">
                  <div class="aspect-[7/4] bg-stone-100 overflow-hidden">
                    <img src="${escapeHtml(primaryImg)}" alt="${escapeHtml(item.name)}" class="w-full h-full object-cover" loading="lazy" data-fallback="${escapeHtml(defaultPlaceholder)}" onerror="this.onerror=null;this.src=this.dataset.fallback"/>
                  </div>
                  <div class="p-4 flex flex-col flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="font-display font-semibold text-stone-800 text-lg">${escapeHtml(item.name)}</h3>
                      ${roleBadge}
                    </div>
                    <p class="text-xs text-stone-500 mb-2">${escapeHtml(item.restaurant)}</p>
                    ${(item.description || "").trim() ? `<p class="text-sm text-stone-600 flex-1 line-clamp-2 mb-3">${escapeHtml(item.description)}</p>` : ""}
                    <div class="flex items-center gap-2 text-xs text-stone-500 mb-3">
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800">üåæ ${escapeHtml(macroStr)}</span>
                    </div>
                    <div class="flex items-center justify-between mt-auto gap-3">
                      <span class="text-xl font-bold text-stone-800">${escapeHtml(item.price || "‚Äî")}</span>
                      <button type="button" data-order-btn class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl font-medium text-sm bg-emerald-600 text-white hover:bg-emerald-700 transition-colors shadow-sm shrink-0" data-order-url="${escapeHtml(orderUrl)}">
                        Order ‚Üí
                      </button>
                    </div>
                  </div>
                </div>
                <div class="px-4 pb-4 pt-0 border-t border-stone-100">
                  <button type="button" data-view-nutrition class="inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-amber-100 text-amber-800 hover:bg-amber-200 border border-amber-200/80 transition-colors">
                    <span data-nutrition-label>View nutrition</span>
                    <span data-nutrition-chevron aria-hidden="true">‚ñæ</span>
                  </button>
                  <div data-nutrition-panel class="hidden mt-2 rounded-xl overflow-hidden border border-amber-100 bg-gradient-to-br from-amber-50/80 to-stone-50/80 shadow-inner"></div>
                </div>
              </div>
            `}).join("");
            resultsEl?.classList.remove("hidden");

            listEl.querySelectorAll("[data-view-nutrition]").forEach(btn => {
              btn.addEventListener("click", async (e) => {
                e.preventDefault();
                const card = btn.closest("[data-item-name]");
                if (!card) return;
                const name = card.dataset.itemName || "";
                const panel = card.querySelector("[data-nutrition-panel]");
                const label = card.querySelector("[data-nutrition-label]");
                const chevron = card.querySelector("[data-nutrition-chevron]");
                if (panel.classList.contains("hidden")) {
                  listEl.querySelectorAll("[data-nutrition-panel]").forEach(p => { p.classList.add("hidden"); });
                  listEl.querySelectorAll("[data-nutrition-label]").forEach(l => { l.textContent = "View nutrition"; });
                  listEl.querySelectorAll("[data-nutrition-chevron]").forEach(c => { c.textContent = "‚ñæ"; });
                  const forceRefresh = panel.dataset.forceRefresh === "1";
                  let nut = {};
                  let data = { source: "", notes: "" };
                  const embeddedNut = card.dataset.itemNutrition;
                  if (embeddedNut && !forceRefresh) {
                    try {
                      nut = JSON.parse(embeddedNut) || {};
                      data.source = card.dataset.itemNutritionSource || "openfoodfacts";
                    } catch (_) {}
                  }
                  const hasEmbedded = Object.keys(nut).length > 0;
                  if (!hasEmbedded || forceRefresh) {
                    if (forceRefresh) delete panel.dataset.forceRefresh;
                    if (!panel.dataset.loaded || forceRefresh) {
                      panel.innerHTML = '<div class="p-6 text-center text-amber-600 text-sm">Loading‚Ä¶</div>';
                      try {
                        const desc = (card.dataset.itemDescription || "").trim();
                        const imgUrl = (card.dataset.itemImageUrl || "").trim();
                        const refreshSuffix = forceRefresh ? "&refresh=1" : "";
                        const refreshPrefix = forceRefresh ? "?refresh=1" : "";
                        let res;
                        if (imgUrl || desc) {
                          res = await fetch("/nutrition" + refreshPrefix, {
                            method: "POST",
                            headers: { "Content-Type": "application/json", "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "", "Accept": "application/json" },
                            body: JSON.stringify({ q: name, description: desc, image_url: imgUrl, refresh: forceRefresh })
                          });
                        } else {
                          res = await fetch("/nutrition?q=" + encodeURIComponent(name) + refreshSuffix);
                        }
                        data = await res.json();
                        if (data.error) {
                          panel.innerHTML = '<div class="p-6 text-center text-red-600 text-sm">' + escapeHtml(data.error) + '</div>';
                          return;
                        }
                        nut = data.nutriments || {};
                      } catch (err) {
                        panel.innerHTML = '<div class="p-6 text-center text-red-600 text-sm">Failed to load</div>';
                        return;
                      }
                    }
                  }
                  const p = (nut.protein || 0), c = (nut.carbohydrate || 0), f = (nut.fat || 0);
                  const totalMacro = p + c + f;
                  const hasMacros = totalMacro > 0;
                  const pctP = hasMacros ? (p / totalMacro) * 100 : 33.3;
                  const pctC = hasMacros ? (c / totalMacro) * 100 : 33.3;
                  const pctF = hasMacros ? (f / totalMacro) * 100 : 33.3;
                  const conic = hasMacros
                    ? `conic-gradient(#ea580c 0% ${pctP}%, #d97706 ${pctP}% ${pctP + pctC}%, #059669 ${pctP + pctC}% 100%)`
                    : "conic-gradient(#e7e5e4 0% 100%)";
                  const energy = nut.energy_kcal != null ? nut.energy_kcal : null;
                  const hasAny = energy != null || hasMacros || (nut.fiber != null || nut.sugar != null || nut.sodium != null || nut.salt != null);
                  const extras = [
                    { icon: "üåø", label: "Fiber", val: nut.fiber, unit: "g" },
                    { icon: "üç¨", label: "Sugar", val: nut.sugar, unit: "g" },
                    { icon: "üßÇ", label: "Sodium", val: nut.sodium, unit: "g" },
                    { icon: "üßÇ", label: "Salt", val: nut.salt, unit: "g" }
                  ].filter(x => x.val != null);
                  let html = '<div class="p-5 space-y-4">';
                  html += '<div class="flex items-center gap-4">';
                  html += '<div class="shrink-0 w-20 h-20 rounded-full border-4 border-white shadow-md" style="background: ' + conic + '"></div>';
                  html += '<div class="flex-1 min-w-0 space-y-1">';
                  if (energy != null) html += '<div class="text-lg font-bold text-stone-800">' + escapeHtml(String(energy)) + ' <span class="text-sm font-normal text-stone-500">kcal</span></div>';
                  html += '<div class="flex flex-wrap gap-x-3 gap-y-0.5 text-xs">';
                  if (hasMacros) {
                    html += '<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Protein ' + escapeHtml(String(p)) + 'g</span>';
                    html += '<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span> Carbs ' + escapeHtml(String(c)) + 'g</span>';
                    html += '<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-600"></span> Fat ' + escapeHtml(String(f)) + 'g</span>';
                  } else {
                    html += '<span class="text-stone-500">Macros not available</span>';
                  }
                  html += '</div></div></div>';
                  if (extras.length) {
                    html += '<div class="flex flex-wrap gap-2">';
                    extras.forEach(x => {
                      html += '<div class="flex items-center gap-1.5 rounded-lg bg-white/80 px-3 py-1.5 text-xs shadow-sm border border-stone-100"><span>' + x.icon + '</span><span class="text-stone-600">' + escapeHtml(x.label) + '</span><span class="font-semibold text-stone-800">' + escapeHtml(String(x.val)) + x.unit + '</span></div>';
                    });
                    html += '</div>';
                  }
                  if (data.source) html += '<div class="pt-1 text-[10px] text-stone-400">Source: ' + escapeHtml(data.source === "openai_vision" ? "AI estimate" : data.source === "generic_estimate" ? "Rough estimate" : "Open Food Facts") + (data.confidence ? ' ¬∑ ' + escapeHtml(data.confidence) + ' confidence' : '') + '</div>';
                  if (data.notes) html += '<div class="pt-0.5 text-[10px] text-stone-500 italic">' + escapeHtml(data.notes) + '</div>';
                  html += '<div class="pt-2"><button type="button" data-refresh-nutrition class="text-xs text-amber-600 hover:text-amber-700 hover:underline">Refresh values</button></div>';
                  html += '</div>';
                  panel.innerHTML = hasAny ? html : '<div class="p-6 text-center text-stone-500 text-sm">No nutrition data found</div><div class="p-2"><button type="button" data-refresh-nutrition class="text-xs text-amber-600 hover:text-amber-700 hover:underline">Refresh values</button></div>';
                  panel.dataset.loaded = "1";
                  card.dataset.itemNutrition = JSON.stringify(nut);
                  card.dataset.itemNutritionSource = data.source || "";
                  panel.classList.remove("hidden");
                  if (label) label.textContent = "Hide nutrition";
                  if (chevron) chevron.textContent = "‚ñ¥";
                } else {
                  panel.classList.add("hidden");
                  if (label) label.textContent = "View nutrition";
                  if (chevron) chevron.textContent = "‚ñæ";
                }
              });
            });
          }

          // Show results on load: server-rendered initial items first, else fetch cached
          const initialEl = document.getElementById("initial-food-items");
          if (initialEl && initialEl.textContent) {
            try {
              const items = JSON.parse(initialEl.textContent);
              if (Array.isArray(items) && items.length > 0) {
                renderResults(items);
                fetch(`/warm_cache?patient_id=${patientId}&city=braga-norte`).catch(() => {});
                return;
              }
            } catch (_) {}
          }
          Promise.all([
            fetch(`/cached_food?patient_id=${patientId}`).then(r => r.ok ? r.json() : null).catch(() => null),
            fetch(`/cached_grocery_basket?patient_id=${patientId}&city=braga-norte`).then(r => r.ok ? r.json() : null).catch(() => null)
          ]).then(([food, basket]) => {
            const items = mergeItems(food, basket);
            if (items.length > 0) renderResults(items);
          }).finally(() => {
            fetch(`/warm_cache?patient_id=${patientId}&city=braga-norte`).catch(() => {});
          });

          btn.addEventListener("click", async () => {
            const spinner = document.querySelector("[data-find-food-spinner]");
            const label = document.querySelector("[data-find-food-label]");
            btn.disabled = true;
            spinner?.classList.remove("hidden");
            label.textContent = "Checking‚Ä¶";
            resultsEl?.classList.add("hidden");
            errorEl?.classList.add("hidden");
            errorEl.textContent = "";
            try {
              const [foodRes, basketRes] = await Promise.all([
                fetch(`/find_food?patient_id=${patientId}`),
                fetch(`/grocery_basket?patient_id=${patientId}&city=braga-norte`)
              ]);
              const foodData = foodRes.ok ? await foodRes.json() : null;
              const basketData = basketRes.ok ? await basketRes.json() : null;
              const items = mergeItems(foodData || {}, basketData || {});
              if (items.length === 0) {
                const err = !foodRes.ok && foodData?.error ? foodData.error : (!basketRes.ok && basketData?.error ? basketData.error : "No items found");
                throw new Error(err);
              }
              renderResults(items);
            } catch (err) {
              errorEl.textContent = err.message;
              errorEl?.classList.remove("hidden");
            } finally {
              btn.disabled = false;
              spinner?.classList.add("hidden");
              label.textContent = "Find food";
            }
          });

          document.querySelector("[data-add-to-cart]")?.addEventListener("click", async () => {
            const basketItems = currentItems.filter(i => i.store_url || i.basket_role);
            const storeUrl = basketItems[0]?.store_url || basketItems[0]?.restaurant_url;
            if (!storeUrl || !basketItems.length) {
              alert("Select a basket (grocery items) first. Basket items have a role badge.");
              return;
            }
            const btn = document.querySelector("[data-add-to-cart]");
            btn.disabled = true;
            try {
              const res = await fetch("/add_basket_to_cart", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "",
                  "Accept": "application/json"
                },
                body: JSON.stringify({
                  store_url: storeUrl,
                  items: basketItems.map(i => ({ name: i.name }))
                })
              });
              const data = await res.json();
              if (data.message) alert(data.message);
              if (data.added === 0 && data.failed?.length) alert("Could not add: " + data.failed.slice(0, 3).join(", ") + (data.failed.length > 3 ? "..." : ""));
            } catch (err) {
              alert(err.message || "Failed. Ensure API is running and CHROME_CDP_URL is set.");
            } finally {
              btn.disabled = false;
            }
          });

          document.querySelector("[data-add-to-log]")?.addEventListener("click", async () => {
            if (!currentItems.length) return;
            const addLogBtn = document.querySelector("[data-add-to-log]");
            addLogBtn.disabled = true;
            try {
              const res = await fetch("/add_to_food_log", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || "",
                  "Accept": "application/json"
                },
                body: JSON.stringify({
                  patient_id: patientId,
                  items: currentItems.map(i => ({ name: i.name, restaurant: i.restaurant })),
                  meal_type: "Refei√ß√£o"
                })
              });
              const data = await res.json();
              if (res.ok) window.location.reload();
              else alert(data.error || "Failed to add to food log");
            } catch (err) {
              alert(err.message || "Failed to add to food log");
            } finally {
              addLogBtn.disabled = false;
            }
          });
        }
        function escapeHtml(s) {
          const div = document.createElement("div");
          div.textContent = s || "";
          return div.innerHTML;
        }
        function onLoad() {
          initFindFood();
        }
        document.addEventListener("turbo:load", onLoad);
        document.addEventListener("DOMContentLoaded", onLoad);
      </script>
    <% end %>
  <% else %>
    <div class="rounded-2xl bg-white border border-stone-200/80 shadow-sm p-12 text-center">
      <p class="text-5xl mb-4" aria-hidden="true">ü•ó</p>
      <p class="text-stone-600 font-medium">No patients in database.</p>
      <p class="text-stone-500 text-sm mt-1">Run seeds to load data.</p>
    </div>
  <% end %>
</div>
